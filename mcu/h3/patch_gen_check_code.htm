<!--
 ____________________________________________________________
|                                                            |
|    DESIGN + Pat Heard { http://fullahead.org }             |
|      DATE + 2006.09.12                                     |
| COPYRIGHT + Free use if this notice is kept in place.      |
|____________________________________________________________|

-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>司徒的教學網站</title>
  <meta http-lowast="content-type" content="application/xhtml+xml; charset=UTF-8" />
  <meta name="author" content="fullahead.org" />
  <meta name="keywords" content="XHTML, CSS, template, FullAhead" />
  <meta name="description" content="A valid, XHTML 1.0 template" />
  <meta name="robots" content="index, follow, noarchive" />
  <meta name="googlebot" content="noarchive" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.1, maximum-scale=100.0"/>

  <link rel="shortcut icon" href="../../website.ico">
  <link rel="stylesheet" type="text/css" href="../../styles/shCore.css" />
  <link rel="stylesheet" type="text/css" href="../../styles/shThemeDefault.css" />
  <link rel="stylesheet" type="text/css" href="../../css/html.css" media="screen, projection, tv " />
  <link rel="stylesheet" type="text/css" href="../../css/layout.css" media="screen, projection, tv" />
  <link rel="stylesheet" type="text/css" href="../../css/print.css" media="print" />
  
  <script type="text/javascript" src="../../scripts/shCore.js"></script>
  <script type="text/javascript" src="../../scripts/shBrushCpp.js"></script>

  <!-- Conditional comment to apply opacity fix for IE #content background.
       Invalid CSS, but can be removed without harming design -->
  <!--[if gt IE 5]>
  <link rel="stylesheet" type="text/css" href="css/ie.css" media="screen, projection, tv " />
  <![endif]-->
</head>

<body>
<script type="text/javascript">SyntaxHighlighter.all();</script>
<div id="wrapper">
<div id="content">
<script type="text/javascript" src="../../header.js"></script>
<div id="page">
<h3>NanoPi NEO</h3>
<p><b>解決無法在x86編譯的問題</b></p>
<hr size="1">
<p>
diff
</p>
<pre>
diff -Nur arch/arm/mach-sunxi/power/brom/Makefile arch/arm/mach-sunxi/power/brom/Makefile
--- arch/arm/mach-sunxi/power/brom/Makefile  2016-03-07 23:43:50.629142681 +0100
+++ arch/arm/mach-sunxi/power/brom/Makefile  2016-03-07 23:52:43.092375154 +0100
@@ -3,6 +3,8 @@
 always  := resumes.code
 targets := resumes.elf
 
+hostprogs-y  := mksunxichecksum
+
 #use "-Os" flags.
 #Don't use "-O2" flags.
 KBUILD_CFLAGS := -g -c -nostdlib -march=armv7-a -marm -fno-unwind-tables -fno-asynchronous-unwind-tables -mlittle-endian -O2
@@ -22,8 +24,8 @@
 
 resumes-y := $(addprefix $(obj)/,$(resumes-y))
 
-$(obj)/resumes.code: $(src)/gen_check_code $(obj)/resumes.bin
-  $(Q)$&lt; $(obj)/resumes.bin $(obj)/resumes.code
+$(obj)/resumes.code: $(obj)/resumes.bin $(obj)/mksunxichecksum
+  $(obj)/mksunxichecksum $(obj)/resumes.bin $(obj)/resumes.code
 
 $(obj)/resumes.bin: $(obj)/resumes.elf FORCE
   $(Q)$(CROSS_COMPILE)objcopy -O binary $(obj)/resumes.elf $(obj)/resumes.bin
diff -Nur arch/arm/mach-sunxi/power/brom/mksunxichecksum.c arch/arm/mach-sunxi/power/brom/mksunxichecksum.c
--- arch/arm/mach-sunxi/power/brom/mksunxichecksum.c  1970-01-01 01:00:00.000000000 +0100
+++ arch/arm/mach-sunxi/power/brom/mksunxichecksum.c  2016-01-05 19:45:42.000000000 +0100
@@ -0,0 +1,98 @@
+/*
+ * (C) Copyright 2015 Jean-Francois Moine
+ * (C) Copyright 2014 Henrik Nordstrom
+ *
+ * Based on mksunxiboot
+ *
+ * (C) Copyright 2007-2011
+ * Allwinner Technology Co., Ltd. &lt;www.allwinnertech.com&gt;
+ *
+ * SPDX-License-Identifier:  GPL-2.0+
+ */
+#include &lt;stdio.h&gt;
+#include &lt;string.h&gt;
+#include &lt;errno.h&gt;
+#include &lt;stdint.h&gt;
+#include &lt;stdlib.h&gt;
+
+/* boot head definition from sun4i boot code */
+struct boot_file_head {
+  uint32_t b_instruction;  /* one intruction jumping to real code */
+  uint8_t magic[8];  /* ="eGON.BT0" or "eGON.BT1", not C-style str */
+  uint32_t check_sum;  /* generated by PC */
+  uint32_t length;  /* generated by PC */
+  /*
+   * We use a simplified header, only filling in what is needed
+   * for checksum calculation.
+   */
+};
+
+#define STAMP_VALUE                     0x5F0A6C39
+
+/* check sum functon from sun4i boot code */
+static int gen_check_sum(struct boot_file_head *head_p)
+{
+  uint32_t length;
+  uint32_t *buf;
+  uint32_t loop;
+  uint32_t i;
+  uint32_t sum;
+
+  length = head_p-&gt;length;
+//  if ((length &amp; 0x3) != 0)  /* must 4-byte-aligned */
+//    return -1;
+  buf = (uint32_t *)head_p;
+  head_p-&gt;check_sum = STAMP_VALUE;  /* fill stamp */
+  loop = length &gt;&gt; 2;
+
+  /* calculate the sum */
+  for (i = 0, sum = 0; i &lt; loop; i++)
+    sum += buf[i];
+
+  /* write back check sum */
+  head_p-&gt;check_sum = sum;
+
+  return 0;
+}
+
+int main(int argc, char *argv[])
+{
+  struct boot_file_head h, *buf;
+  unsigned file_size;
+  FILE *f;
+
+  if (argc != 3) {
+    printf("Usage: %s file.bin file.code\n"
+           "calculates BROM checksum in boot header of given .bin file and writes to .code file\n"
+           "", argv[0]);
+    exit(1);
+  }
+
+  f = fopen(argv[1], "rb");
+  if (!f) {
+    perror("Open input file");
+    exit(1);
+  }
+
+  fread(&amp;h, 1, sizeof h, f);
+  file_size = h.length;      // wanted length
+
+  buf = malloc(file_size);
+  memset(buf, 0xff, file_size);
+  rewind(f);
+
+  fread(buf, 1, file_size, f);
+  fclose(f);
+
+  gen_check_sum(buf);
+
+  f = fopen(argv[2], "wb");
+  if (!f) {
+    perror("Open output file");
+    exit(1);
+  }
+  fwrite(buf, 1, file_size, f);
+  fclose(f);
+
+  return 0;
+}
</pre><br>

<p>
<br><a href="../../mcu.htm">返回上一頁</a>
</p>

</div>
</div>
</div>
</body>
</html>
